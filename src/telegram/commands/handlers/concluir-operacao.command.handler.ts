import { Injectable, Logger } from '@nestjs/common';
import { Types } from 'mongoose';
import { OperationsService } from '../../../operations/operations.service';
import { TelegramKeyboardService } from '../../shared/telegram-keyboard.service';
import {
  ITextCommandHandler,
  TextCommandContext,
} from 'src/telegram/telegram.types';

@Injectable()
export class ConcluirOperacaoCommandHandler implements ITextCommandHandler {
  private readonly logger = new Logger(ConcluirOperacaoCommandHandler.name);
  command = /^\/concluiroperacao(?:@\w+)?\s+([a-f0-9]{24})$/;

  constructor(
    private readonly operationsService: OperationsService,
    private readonly keyboardService: TelegramKeyboardService,
  ) {}

  async handle(ctx: TextCommandContext): Promise<void> {
    const match = ctx.message.text.match(this.command);
    if (!match) {
      await ctx.reply(
        '‚ñº Formato incorreto. Use:\n' +
        '`/concluiroperacao [ID_DA_OPERACAO]`\n\n' +
        'Exemplo: `/concluiroperacao 507f1f77bcf86cd799439011`\n\n' +
        'Este comando s√≥ pode ser usado pelos participantes da opera√ß√£o.',
        { parse_mode: 'Markdown' }
      );
      return;
    }

    const [, operationId] = match;
    const userId = new Types.ObjectId(ctx.from.id.toString());

    try {
      const completedOperation = await this.operationsService.completeOperation(
        new Types.ObjectId(operationId),
        userId,
      );

      const typeText = completedOperation.type === 'buy' ? 'COMPRA' : 'VENDA';
      const total = completedOperation.amount * completedOperation.price;
      const userMention = `@${ctx.from.username || ctx.from.first_name}`;
      
      await ctx.reply(
        `‚úÖ **Opera√ß√£o Conclu√≠da!**\n\n` +
        `${userMention} marcou a opera√ß√£o como conclu√≠da:\n\n` +
        `${typeText}\n` +
        `Ativos: ${completedOperation.assets.join(', ')}\n` +
        `Quantidade: ${completedOperation.amount}\n` +
        `Pre√ßo: R$ ${total.toFixed(2)}\n` +

        `Redes: ${completedOperation.networks.map(n => n.toUpperCase()).join(', ')}\n\n` +
        `üéâ **Parab√©ns pela transa√ß√£o bem-sucedida!**\n\n` +
        `üí° **Lembrete:** N√£o se esque√ßam de se avaliarem mutuamente usando:\n` +
        `\`/avaliar positiva Transa√ß√£o r√°pida e confi√°vel\`\n` +
        `(respondam √† mensagem um do outro)`,
        { parse_mode: 'Markdown' }
      );

      this.logger.log(
        `Operation ${operationId} completed by user ${userId}`,
      );
      
    } catch (error) {
      this.logger.error('Error completing operation:', error);
      
      if (error instanceof Error) {
        await ctx.reply(`‚ñº ${error.message}`);
      } else {
        await ctx.reply('‚ñº Erro ao concluir opera√ß√£o. Tente novamente.');
      }
    }
  }
}